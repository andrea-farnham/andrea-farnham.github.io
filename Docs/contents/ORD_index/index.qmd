---
title: "Data index"
subtitle: "An example of a data index to navigate through metadata and showcase preview images" 
author: "G.Fraga Gonzalez"
affiliation: "Center for Reproducible Science, UZH"
date: last-modified
format: 
  html:
    code-overflow: scroll
--- 

# A data hub {.unnumbered}


This is a demo of a simple data hub that allows to navigate through a table with metadata and thumbnail images. The idea is to facilitate finding and sharing your data. Visit our [Tutorials page]('.\contents\tutorials\index.qmd') for more details on this workflow. 

In short, for the hub you need: (1) a source of structured metadata, i.e., tables (2) if you are to display thumbnails you need the image files (3) some R code to render the table interactive with the package [DT](https://rstudio.github.io/DT/). (4) R Quarto to create the entire page as html 

::: {.callout-warning style="font-size: 4px"}
## Instructions

The highlighted columns below correspond to the metadata table created from the filenames in the folder. Use the \*filter boxes\* to select which data are displayed. You can also \*select Columns\* to choose which columns are displayed or change the column order if you \*click and drag\* on the variable names. You can also \*select\* one or multiple rows clicking on them or by using the \*select\* buttons. Click on a thumbnail to open the full-size image.

Click the button \*Copy\* to copy the filtered or selected rows to the clipboard. With the buttons \*csv\* or \*pdf\* you can save them to these two formats.
:::

```{r}
library(dplyr)

tbl <-  readxl::read_excel('DummyData1_20241234_subjects.xlsx',na=c("","N/A"))
# Minor fix to date-time format 
colsWithTime <- colnames(tbl)[grep('*time*',colnames(tbl))] # find variables with 
tbl <- tbl %>%  mutate(across(all_of(colsWithTime), ~ format(., format = "%H:%M")))

```

```{r}
dirinput <- file.path('Images')

# List all files with .jpg extension
files <- dir(dirinput)
extension <- '.jpg'
filenames <- files[grepl(paste0('*',extension,'$'),files)]

tbl_files <- as.data.frame(filenames)
tbl_files$sname <- sapply(strsplit(filenames,'-'),'[[',1)
```

```{r}
tbl_joined  <- full_join(x=tbl,
                         y = tbl_files,
                         by=join_by("subjID"=="sname"),
                         keep=TRUE)


```

```{r}
pic_fullpath <- file.path('https://gitlab.uzh.ch/crsuzh/afford_website/-/tree/master/Docs/contents/hub/Images',tbl_joined$filenames)
pic_relpath <- file.path('.','contents','hub',tbl_joined$filenames)

# add paths to filenames + some html code 
tbl_joined$pic <- paste0('<a href=\'', pic_fullpath,'\' target=\'_blank\'>', 
                       '<img src=\'',pic_relpath, '\' height=\'70\'></a>')


```

```{r}
library(crosstalk) # this package makes it possible to filter 
library(DT)
# an object that will be shared by filter panels and datatable 
shared_joined <- SharedData$new(tbl_joined, key = ~subjID, group = "shared_obj")

# to make two columns one with filter panels and one with the table
bscols(widths = c(2,10),
     device = c("xs", "sm", "md", "lg"),

# filter panels. Other formats are sliders and checkboxes https://rstudio.github.io/crosstalk/using.html
list(
 filter_select( id = "subjID", label = "subject",sharedData = shared_joined, group = ~subjID),
 filter_checkbox("Sex","Sex",shared_joined, ~Sex, inline = FALSE)
),

# table
datatable(
    shared_joined,
    #filter = "top",
    escape = FALSE,
    rownames = FALSE,
    width = "100%",
    class = 'compact cell-border  hover', 
    extensions = c('Buttons', 'Select','ColReorder', 'Scroller',  'KeyTable'),
    selection = 'none',
    options = list(
      pageLength = 20,
      dom = 'Bfrtip',
      #buttons = c('colvis','selectAll', 'selectNone', 'copy', 'csv', 'pdf'),  
      buttons = list(list(extend = "colvis", text = "select Columns", background='yellow'),
                     'selectAll', 'selectNone', 'copy', 'csv', 'pdf'), 
      select = list(style = 'os', items = 'row'),
      scrollX = TRUE,
      scrollCollapse = FALSE,  
      autoWidth = TRUE,
      colReorder = TRUE,
      columnDefs = list(
        list(
          keys = TRUE,
          search = list(regex = TRUE),
          targets=0
        )
      )
      )
  ) 
%>% 
formatStyle(colnames(tbl),backgroundColor = "ivory")  
)


```
